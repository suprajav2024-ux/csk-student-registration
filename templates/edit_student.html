{% extends "base.html" %}
{% block content %}

<div class="container py-5">
    <div class="card shadow-sm p-4 mx-auto" style="max-width: 900px;">
        <h2 class="text-center mb-4">Edit Student</h2>

        <form method="POST">

            <!-- Student Info -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-control" name="name"
                           value="{{ student['Student Name'] }}" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Grade</label>
                    <select class="form-select" id="grade_select" name="grade" required>
                        {% for g in ['I','II','III','IV','V','VI','VII','VIII'] %}
                        <option value="{{ g }}"
                            {% if student['Class'] == g %}selected{% endif %}>
                            {{ g }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Section</label>
                    <select class="form-select" name="section" required>
                        {% for s in ['A','B','C'] %}
                        <option value="{{ s }}"
                            {% if student['Section'] == s %}selected{% endif %}>
                            {{ s }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Events -->
            <h5 class="mt-4">Events</h5>
            <div class="row">

                {% set slots = [
                    ('10-11am','event_10_11','Event 10-11'),
                    ('11-12pm','event_11_12','Event 11-12'),
                    ('1-2pm','event_1_2','Event 1-2'),
                    ('2-3pm','event_2_3','Event 2-3')
                ] %}

                {% for label, field, sheet_key in slots %}
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">{{ label }}</label>
                    <select class="form-select event-slot"
                            id="{{ field }}" name="{{ field }}">
                        <option value="Not participating">Not participating</option>

                        {% for ev in event_options[student['Class']][label] %}
                        <option value="{{ ev }}"
                            {% if student[sheet_key] == ev %}selected{% endif %}>
                            {{ ev }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}

            </div>

            <button class="btn btn-primary w-100 mt-4">Update Student</button>
        </form>
    </div>
</div>

<script>
const eventOptions = {{ event_options | tojson }};
const eventSlotMap = {{ event_slot_map | tojson }};

const slotIdMap = {
    "10-11am": "event_10_11",
    "11-12pm": "event_11_12",
    "1-2pm": "event_1_2",
    "2-3pm": "event_2_3"
};

let activeLinkedEvent = null;

/* ---------- Helpers ---------- */
function resetSlot(selectId) {
    const select = document.getElementById(selectId);
    for (let opt of select.options) {
        opt.disabled = false;
    }
}

function lockSlot(selectId, allowedEvent) {
    const select = document.getElementById(selectId);
    for (let opt of select.options) {
        opt.disabled = (opt.value !== allowedEvent && opt.value !== "Not participating");
    }
    select.value = allowedEvent;
}

/* ---------- Core logic ---------- */
function handleSlotChange(changedSelectId) {
    const changedSelect = document.getElementById(changedSelectId);
    const selectedEvent = changedSelect.value;

    // CASE 1: switched to Not participating
    if (selectedEvent === "Not participating") {

        if (activeLinkedEvent && eventSlotMap[activeLinkedEvent]) {
            eventSlotMap[activeLinkedEvent].forEach(slot => {
                document.getElementById(slotIdMap[slot]).value = "Not participating";
            });
        }

        activeLinkedEvent = null;
        Object.values(slotIdMap).forEach(resetSlot);
        return;
    }

    // CASE 2: multi-slot event
    if (eventSlotMap[selectedEvent]) {
        activeLinkedEvent = selectedEvent;

        eventSlotMap[selectedEvent].forEach(slot => {
            lockSlot(slotIdMap[slot], selectedEvent);
        });
        return;
    }

    // CASE 3: single-slot event
    activeLinkedEvent = null;
    Object.values(slotIdMap).forEach(resetSlot);
}

/* ---------- Attach listeners ---------- */
Object.values(slotIdMap).forEach(id => {
    document.getElementById(id).addEventListener("change", () => {
        handleSlotChange(id);
    });
});

/* ---------- Initialize existing linked events on load ---------- */
document.addEventListener("DOMContentLoaded", () => {
    Object.values(slotIdMap).forEach(id => {
        const val = document.getElementById(id).value;
        if (eventSlotMap[val]) {
            activeLinkedEvent = val;
            eventSlotMap[val].forEach(slot => {
                lockSlot(slotIdMap[slot], val);
            });
        }
    });
});
</script>

{% endblock %}
